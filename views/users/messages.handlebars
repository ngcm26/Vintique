
<!-- Messages Interface - Full Width Design -->
<link rel="stylesheet" href="/assets/css/users/messages.css">

<!-- Hero Section - Full Width -->
<section class="hero-section">
  <div class="hero-content">
    <h1 class="hero-title">Your Messages</h1>
    <p class="hero-subtitle">Connect with sellers and buyers in our sustainable fashion community</p>
  </div>
</section>

<!-- Main Messages Container - Full Width -->
<div class="messages-container">
  <!-- Conversations Sidebar -->
  <div class="conversations-sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <span>Conversations</span>
        <span class="badge bg-secondary" id="totalCount">{{#if conversations}}{{conversations.length}}{{else}}0{{/if}}</span>
        <button class="new-chat-btn" onclick="openNewChatModal()" title="Start New Chat">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="conversation-tabs">
        <button class="tab-btn active" onclick="filterConversations('all')">All</button>
        <button class="tab-btn" onclick="filterConversations('archived')">Archived</button>
        <button class="tab-btn" onclick="filterConversations('muted')">Muted</button>
        <button class="tab-btn" onclick="filterConversations('blocked')">Blocked</button>
      </div>
      <div class="search-messages">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search conversations..." id="searchConversations">
      </div>
    </div>
    <div class="conversations-list" id="conversationsList">
      {{#if conversations}}
        {{#each conversations}}
          <div class="conversation-item" data-status="active" data-conversation-id="{{this.conversation_id}}" data-listing-id="{{this.listing_id}}" onclick="selectConversation({{this.conversation_id}}, '{{this.other_user_name}}', '{{this.listing_title}}', {{this.listing_id}})">
            <div class="conversation-header">
              <span class="conversation-name">{{this.other_user_name}}</span>
              <span class="conversation-time">
                {{#if this.last_message_time}}
                  {{timeAgo this.last_message_time}}
                {{else}}
                  {{timeAgo this.created_at}}
                {{/if}}
              </span>
              {{#if this.unread_count}}
                <span class="unread-badge">{{this.unread_count}}</span>
              {{/if}}
            </div>
            <div class="conversation-preview">{{this.last_message_preview}}</div>
            {{#if this.listing_title}}
              <div class="product-tag">Re: {{this.listing_title}}</div>
            {{/if}}
          </div>
        {{/each}}
      {{else}}
        <div class="conversation-item empty-state">
          <div class="conversation-header">
            <span class="conversation-name">No conversations yet</span>
            <span class="conversation-time">-</span>
          </div>
          <div class="conversation-preview">
            {{#if user}}
              Click the + button above to start your first conversation, or browse listings and click "Contact Seller"!
            {{else}}
              Please log in to view your messages.
            {{/if}}
          </div>
        </div>
      {{/if}}
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div class="chat-header">
      <div>
        <div class="chat-title" id="chatTitle">Select a conversation</div>
        <div class="chat-subtitle" id="chatSubtitle">Choose a conversation to start messaging</div>
      </div>
      <div class="chat-actions">
        <button class="chat-action-btn" title="View Product" onclick="viewProductDetails()" id="viewProductBtn" style="display: none;">
          <i class="fas fa-external-link-alt"></i>
        </button>
        <button class="chat-action-btn" title="More Options" onclick="showChatOptions()" id="chatOptionsBtn" style="display: none;">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
    </div>

    <div class="messages-area" id="messagesArea">
      <div class="empty-chat">
        <i class="fas fa-comments"></i>
        <h5>No conversation selected</h5>
        <p>Choose a conversation from the sidebar to start messaging</p>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator" style="display: none;">
      <span id="typingUser">Someone is typing</span>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <div class="message-input-area" id="messageInputArea" style="display: none;">
      <div class="message-input-container">
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
        <button class="attach-btn" onclick="document.getElementById('imageInput').click()" title="Attach Image">
          <i class="fas fa-paperclip"></i>
        </button>
        <textarea class="message-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendChatMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div class="image-preview" id="imagePreview" style="display: none;">
        <div class="preview-container">
          <img id="previewImage" src="" alt="Preview">
          <button class="remove-image-btn" onclick="removeImagePreview()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Chat Modal -->
<div class="new-chat-modal" id="newChatModal">
  <div class="modal-content-custom">
    <div class="modal-header-custom">
      <div class="d-flex justify-content-between align-items-center w-100">
        <h3 class="modal-title-custom">Start New Conversation</h3>
        <button class="close-btn" onclick="closeNewChatModal()">&times;</button>
      </div>
    </div>
    
    <div class="modal-body-custom">
      <div class="new-chat-form">
        <div class="form-group mb-3">
          <label for="recipientEmail">Recipient Email:</label>
          <input type="email" id="recipientEmail" class="form-control" placeholder="Enter email address">
        </div>
        <div class="form-group mb-3">
          <label for="initialMessage">Message:</label>
          <textarea id="initialMessage" class="form-control" rows="3" placeholder="Type your message..."></textarea>
        </div>
        <button class="btn btn-primary w-100" onclick="startNewChatFromForm()">Send Message</button>
      </div>
      
      <hr class="my-4">
      
      <div class="recent-contacts">
        <h6 class="section-title">Quick Start</h6>
        
        <div class="contact-item" onclick="openNewConversationForm()">
          <div class="contact-avatar">+</div>
          <div class="contact-info">
            <h6>Start New Chat</h6>
            <p>Enter email to start a conversation</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer-custom">
      <p>Or browse the <a href="/marketplace">marketplace</a> to message sellers directly</p>
    </div>
  </div>
</div>

<!-- Chat Options Modal -->
<div class="chat-options-modal" id="chatOptionsModal">
  <div class="options-content">
    <div class="options-header">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="options-title">Chat Options</h4>
        <button class="close-btn" onclick="closeChatOptionsModal()" style="background: rgba(255,255,255,0.2);">&times;</button>
      </div>
    </div>
    
    <div class="options-list">
      <!-- Dynamic content will be inserted here by JavaScript -->
    </div>
  </div>
</div>

<script>
// Use the properly serialized data from the server
let conversations = {{{conversationsJson}}};
let currentUser = {{{userJson}}};
let currentConversationId = null;
let currentListingId = null;
let selectedImage = null;

console.log('Loaded conversations:', conversations);
console.log('Current user:', currentUser);

document.addEventListener('DOMContentLoaded', function() {
  console.log('Messages page loaded');
  
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage(); // FIXED: Use the specific function name
      }
    });
  }

  const initialMessageInput = document.getElementById('initialMessage');
  if (initialMessageInput) {
    initialMessageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  }

  const searchInput = document.getElementById('searchConversations');
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const conversationItems = document.querySelectorAll('.conversation-item:not(.empty-state)');
      
      conversationItems.forEach(conv => {
        const name = conv.querySelector('.conversation-name')?.textContent.toLowerCase() || '';
        const preview = conv.querySelector('.conversation-preview')?.textContent.toLowerCase() || '';
        const product = conv.querySelector('.product-tag')?.textContent.toLowerCase() || '';
        
        if (name.includes(searchTerm) || preview.includes(searchTerm) || product.includes(searchTerm)) {
          conv.style.display = 'block';
        } else {
          conv.style.display = 'none';
        }
      });
    });
  }

  const urlParams = new URLSearchParams(window.location.search);
  const conversationId = urlParams.get('conversation');
  
  if (conversationId) {
    const convElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (convElement) {
      const listingId = convElement.getAttribute('data-listing-id');
      const otherUser = convElement.querySelector('.conversation-name')?.textContent || 'Unknown User';
      const productTitle = convElement.querySelector('.product-tag')?.textContent.replace('Re: ', '') || null;
      
      selectConversation(conversationId, otherUser, productTitle, listingId);
    }
  }

  const newChatModal = document.getElementById('newChatModal');
  if (newChatModal) {
    newChatModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeNewChatModal();
      }
    });
  }

  const chatOptionsModal = document.getElementById('chatOptionsModal');
  if (chatOptionsModal) {
    chatOptionsModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeChatOptionsModal();
      }
    });
  }
});

async function selectConversation(conversationId, otherUser, productTitle, listingId = null) {
  if (!currentUser) {
    showNotification('Please log in to view messages', 'error');
    return;
  }

  currentConversationId = conversationId;
  currentListingId = listingId;
  
  document.querySelectorAll('.conversation-item').forEach(item => {
    item.classList.remove('active');
  });
  
  const clickedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
  if (clickedItem) {
    clickedItem.classList.add('active');
    
    const badge = clickedItem.querySelector('.unread-badge');
    if (badge) {
      badge.remove();
    }
  }
  
  document.getElementById('chatTitle').textContent = otherUser || 'Unknown User';
  document.getElementById('chatSubtitle').textContent = productTitle ? `About: ${productTitle}` : 'General conversation';
  
  document.getElementById('messageInputArea').style.display = 'block';
  document.getElementById('viewProductBtn').style.display = productTitle ? 'block' : 'none';
  document.getElementById('chatOptionsBtn').style.display = 'block';
  
  await loadMessages(conversationId);
}

async function loadMessages(conversationId) {
  try {
    const response = await fetch(`/api/conversations/${conversationId}/messages`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const messages = await response.json();
    
    // Clear messages area after we get the response
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.innerHTML = '';
    
    // Check if we have a listing ID to show product card
    if (currentListingId) {
      const product = await fetchProductInfo(currentListingId);
      if (product) {
        displayProductCard(product);
      }
    } else {
      // Check if the first message has a listing_id
      if (messages.length > 0 && messages[0].listing_id) {
        const product = await fetchProductInfo(messages[0].listing_id);
        if (product) {
          displayProductCard(product);
        }
      } else {
        removeProductCard();
      }
    }
    
    displayMessages(messages);
  } catch (error) {
    console.error('Error loading messages:', error);
    
    // Show error in the messages area instead of using showError
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.innerHTML = `
      <div class="empty-chat">
        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
        <h5>Failed to load messages</h5>
        <p>Please try refreshing the page or selecting the conversation again.</p>
      </div>
    `;
  }
}

async function fetchProductInfo(listingId) {
  try {
    // Create a specific endpoint for fetching a single listing
    const response = await fetch(`/api/listings/${listingId}`);
    if (!response.ok) {
      // Fallback to fetching all listings and filtering
      const allListingsResponse = await fetch(`/api/listings`);
      if (!allListingsResponse.ok) return null;
      const listings = await allListingsResponse.json();
      return listings.find(l => l.listing_id == listingId);
    }
    return await response.json();
  } catch (e) {
    console.error('Error fetching product info:', e);
    return null;
  }
}

function displayProductCard(product) {
  removeProductCard();
  if (!product) return;
  
  const messagesArea = document.getElementById('messagesArea');
  const card = document.createElement('div');
  card.className = 'chat-product-card';
  card.innerHTML = `
    <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); border-radius: 16px; margin-bottom: 1rem; padding: 1.5rem; display: flex; align-items: center; box-shadow: 0 4px 12px rgba(255,193,7,0.15); border: 1px solid rgba(255,193,7,0.2);">
      <div style="width: 80px; height: 80px; border-radius: 12px; overflow: hidden; margin-right: 1.5rem; flex-shrink: 0;">
        <img src="${product.image_url || '/assets/logo.png'}" alt="${product.title}" style="width: 100%; height: 100%; object-fit: cover;">
      </div>
      <div style="flex: 1;">
        <div style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 0.25rem;">${escapeHtml(product.title)}</div>
        <div style="color: #666; font-size: 0.95rem; margin-bottom: 0.25rem;">${escapeHtml(product.category)} • <span style="font-weight: 600; color: #27ae60;">$${product.price}</span></div>
        <div style="color: #888; font-size: 0.9rem;">${product.brand ? escapeHtml(product.brand) + ' • ' : ''}${escapeHtml(product.item_condition)}</div>
      </div>
      <div style="margin-left: 1rem;">
        <button onclick="viewProductDetails(${product.listing_id})" style="background: linear-gradient(135deg, #FFD700, #FFA500); border: none; padding: 0.5rem 1rem; border-radius: 20px; color: #333; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
          View Item
        </button>
      </div>
    </div>
  `;
  
  // Insert the card at the beginning of messages area
  const firstChild = messagesArea.firstChild;
  messagesArea.insertBefore(card, firstChild);
}

function removeProductCard() {
  const messagesArea = document.getElementById('messagesArea');
  const card = messagesArea.querySelector('.chat-product-card');
  if (card) card.remove();
}

function displayMessages(messages) {
  const messagesArea = document.getElementById('messagesArea');
  
  if (!messages || messages.length === 0) {
    const emptyChat = document.createElement('div');
    emptyChat.innerHTML = `
      <div class="empty-chat">
        <i class="fas fa-comments"></i>
        <h5>No messages yet</h5>
        <p>Start the conversation by sending a message!</p>
      </div>
    `;
    messagesArea.appendChild(emptyChat);
    return;
  }
  
  const currentUserId = currentUser ? (currentUser.user_id || currentUser.id) : null;
  const messagesHTML = messages.map(message => {
    const isOwn = message.sender_id === currentUserId;
    const messageClass = isOwn ? 'sent' : 'received';
    const senderName = isOwn ? 'You' : (message.sender_username || 'Unknown User');
    const messageTime = new Date(message.sent_at).toLocaleString();
    
    // Check if message has an image
    const hasImage = message.image_url && message.image_url.trim() !== '';
    const hasText = message.message_content && message.message_content.trim() !== '';
    
    // Check if message is deleted
    const isDeleted = message.is_deleted === 1;
    const isDeletedForUser = message.deleted_for_user && message.deleted_for_user.includes(currentUserId);
    
    // Skip messages deleted for this user
    if (isDeletedForUser) {
      return '';
    }
    
    let messageContent = '';
    
    if (isDeleted) {
      messageContent = `<div class="message-text deleted-message" style="font-style: italic; color: #888;">This message was deleted</div>`;
    } else {
      if (hasImage) {
        messageContent += `<div class="message-image">
          <img src="${message.image_url}" alt="Shared image" onclick="openImageModal('${message.image_url}')" style="max-width: 250px; max-height: 250px; border-radius: 8px; cursor: pointer;">
        </div>`;
      }
      
      if (hasText) {
        messageContent += `<div class="message-text">${escapeHtml(message.message_content)}</div>`;
      }
    }
    
    return `
      <div class="message ${messageClass}" data-message-id="${message.message_id}">
        <div class="message-bubble" ${isOwn && !isDeleted ? `oncontextmenu="showMessageOptions(event, ${message.message_id})"` : ''}>
          ${messageContent}
          <div class="message-time">${senderName} • ${messageTime}</div>
        </div>
      </div>
    `;
  }).filter(html => html !== '').join('');
  
  // Append messages after any existing product card
  const messagesContainer = document.createElement('div');
  messagesContainer.innerHTML = messagesHTML;
  messagesArea.appendChild(messagesContainer);
  
  messagesArea.scrollTop = messagesArea.scrollHeight;
}

// FIXED: Renamed function to avoid conflicts with chatbot
async function sendChatMessage() {
  console.log('=== SEND CHAT MESSAGE FUNCTION CALLED ===');
  
  if (!currentConversationId) {
    console.error('❌ No conversation selected');
    showNotification('No conversation selected', 'error');
    return;
  }
  console.log('✅ Conversation ID:', currentConversationId);
  
  const messageInput = document.getElementById('messageInput');
  if (!messageInput) {
    console.error('❌ Message input not found');
    showNotification('Message input not found', 'error');
    return;
  }
  console.log('✅ Message input found');
  
  const messageContent = messageInput.value.trim();
  console.log('📝 Message content:', `"${messageContent}"`);
  console.log('🖼️ Selected image:', selectedImage);
  
  // Check if we have either text or image
  if (!messageContent && !selectedImage) {
    console.error('❌ No message content or image');
    showNotification('Please enter a message or select an image', 'error');
    return;
  }
  console.log('✅ Message validation passed');
  
  const sendBtn = document.getElementById('sendBtn');
  if (sendBtn) {
    sendBtn.disabled = true;
    console.log('🔒 Send button disabled');
  }
  
  try {
    let response;
    const url = `/api/conversations/${currentConversationId}/messages`;
    console.log('🌐 Request URL:', url);
    
    if (selectedImage) {
      console.log('📤 Sending message with image');
      // Send with image using FormData
      const formData = new FormData();
      if (messageContent) {
        formData.append('message_content', messageContent);
      }
      formData.append('image', selectedImage);
      
      console.log('📋 FormData contents:');
      for (let [key, value] of formData.entries()) {
        console.log(`  ${key}:`, value);
      }
      
      response = await fetch(url, {
        method: 'POST',
        body: formData
      });
    } else {
      console.log('📤 Sending text message only');
      const requestBody = { message_content: messageContent };
      console.log('📋 Request body:', requestBody);
      
      // Send text only
      response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });
    }
    
    console.log('📡 Response received');
    console.log('📊 Response status:', response.status);
    console.log('📊 Response statusText:', response.statusText);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('❌ Server error response:', errorText);
      console.error(`❌ Full error: ${response.status} ${response.statusText}`);
      
      try {
        const errorJson = JSON.parse(errorText);
        throw new Error(errorJson.error || `Server returned ${response.status}: ${errorText}`);
      } catch (parseError) {
        throw new Error(`Server returned ${response.status}: ${errorText}`);
      }
    }
    
    let data;
    try {
      data = await response.json();
      console.log('✅ Success response parsed:', data);
    } catch (parseError) {
      console.error('❌ Failed to parse response as JSON:', parseError);
      const responseText = await response.text();
      console.error('❌ Raw response:', responseText);
      throw new Error('Invalid JSON response from server');
    }
    
    if (data.success || data.message_id || data.message === 'Message sent successfully') {
      console.log('✅ Message sent successfully!');
      
      // Clear input and reset
      messageInput.value = '';
      messageInput.style.height = 'auto';
      removeImagePreview();
      
      // Reload messages to show the new one
      console.log('🔄 Reloading messages...');
      await loadMessages(currentConversationId);
      
      showNotification('Message sent successfully!', 'success');
    } else {
      console.error('❌ Unexpected response format:', data);
      showNotification('Failed to send message: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('❌ Error sending message:', error);
    console.error('❌ Error stack:', error.stack);
    showNotification('Network error while sending message: ' + error.message, 'error');
  } finally {
    if (sendBtn) {
      sendBtn.disabled = false;
      console.log('🔓 Send button re-enabled');
    }
    console.log('=== SEND CHAT MESSAGE FUNCTION COMPLETE ===');
  }
}

function filterConversations(filter) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  const conversationItems = document.querySelectorAll('.conversation-item');
  
  conversationItems.forEach(conv => {
    const status = conv.dataset.status || 'active';
    
    switch(filter) {
      case 'all':
        conv.style.display = status !== 'blocked' ? 'block' : 'none';
        break;
      case 'archived':
        conv.style.display = status === 'archived' ? 'block' : 'none';
        break;
      case 'muted':
        conv.style.display = status === 'muted' ? 'block' : 'none';
        break;
      case 'blocked':
        conv.style.display = status === 'blocked' ? 'block' : 'none';
        if (status === 'blocked') {
          conv.classList.add('blocked-conversation');
        }
        break;
    }
  });
  
  updateConversationCounts();
}

function updateConversationCounts() {
  const visible = document.querySelectorAll('.conversation-item[style*="block"], .conversation-item:not([style*="none"])').length;
  document.getElementById('totalCount').textContent = visible;
}

function openNewChatModal() {
  document.getElementById('newChatModal').classList.add('show');
  document.getElementById('recipientEmail').value = '';
  document.getElementById('initialMessage').value = '';
}

function closeNewChatModal() {
  document.getElementById('newChatModal').classList.remove('show');
}

function openNewConversationForm() {
  const email = prompt('Enter the email of the person you want to message:');
  if (email && email.trim() !== '') {
    startNewChat(email.trim());
  }
}

async function startNewChatFromForm() {
  const email = document.getElementById('recipientEmail').value.trim();
  const message = document.getElementById('initialMessage').value.trim();
  
  if (!email) {
    showError('Please enter an email address');
    return;
  }
  
  if (!message) {
    showError('Please enter a message');
    return;
  }
  
  try {
    const response = await fetch('/api/conversations', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        seller_email: email,
        initial_message: message
      })
    });

    const data = await response.json();

    if (response.ok) {
      closeNewChatModal();
      showNotification('Message sent successfully!', 'success');
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      showError('Failed to start conversation: ' + data.error);
    }
  } catch (error) {
    console.error('Error starting conversation:', error);
    showError('Network error while starting conversation');
  }
}

function showChatOptions() {
  const activeConversation = document.querySelector('.conversation-item.active');
  
  if (!activeConversation) {
    showNotification('Please select a conversation first', 'error');
    return;
  }
  
  const status = activeConversation.dataset.status || 'active';
  const optionsList = document.querySelector('.options-list');
  
  let optionsHTML = '';
  
  switch(status) {
    case 'blocked':
      optionsHTML = `
        <div class="option-item" onclick="executeOption('unblock')">
          <i class="fas fa-user-check"></i>
          <span>Unblock User</span>
        </div>
        <div class="option-item danger" onclick="executeOption('report')">
          <i class="fas fa-flag"></i>
          <span>Report User</span>
        </div>
      `;
      break;
      
    case 'archived':
      optionsHTML = `
        <div class="option-item" onclick="executeOption('unarchive')">
          <i class="fas fa-box-open"></i>
          <span>Unarchive Conversation</span>
        </div>
        <div class="option-item" onclick="executeOption('mute')">
          <i class="fas fa-bell-slash"></i>
          <span>Mute Notifications</span>
        </div>
        <div class="option-item" onclick="executeOption('clear')">
          <i class="fas fa-broom"></i>
          <span>Clear Chat History</span>
        </div>
        <div class="option-item danger" onclick="executeOption('block')">
          <i class="fas fa-user-slash"></i>
          <span>Block User</span>
        </div>
        <div class="option-item danger" onclick="executeOption('report')">
          <i class="fas fa-flag"></i>
          <span>Report User</span>
        </div>
      `;
      break;
      
    case 'muted':
      optionsHTML = `
        <div class="option-item" onclick="executeOption('unmute')">
          <i class="fas fa-bell"></i>
          <span>Unmute Notifications</span>
        </div>
        <div class="option-item" onclick="executeOption('archive')">
          <i class="fas fa-archive"></i>
          <span>Archive Conversation</span>
        </div>
        <div class="option-item" onclick="executeOption('clear')">
          <i class="fas fa-broom"></i>
          <span>Clear Chat History</span>
        </div>
        <div class="option-item danger" onclick="executeOption('block')">
          <i class="fas fa-user-slash"></i>
          <span>Block User</span>
        </div>
        <div class="option-item danger" onclick="executeOption('report')">
          <i class="fas fa-flag"></i>
          <span>Report User</span>
        </div>
      `;
      break;
      
    default:
      optionsHTML = `
        <div class="option-item" onclick="executeOption('archive')">
          <i class="fas fa-archive"></i>
          <span>Archive Conversation</span>
        </div>
        <div class="option-item" onclick="executeOption('mute')">
          <i class="fas fa-bell-slash"></i>
          <span>Mute Notifications</span>
        </div>
        <div class="option-item" onclick="executeOption('clear')">
          <i class="fas fa-broom"></i>
          <span>Clear Chat History</span>
        </div>
        <div class="option-item danger" onclick="executeOption('block')">
          <i class="fas fa-user-slash"></i>
          <span>Block User</span>
        </div>
        <div class="option-item danger" onclick="executeOption('report')">
          <i class="fas fa-flag"></i>
          <span>Report User</span>
        </div>
      `;
      break;
  }
  
  optionsList.innerHTML = optionsHTML;
  document.getElementById('chatOptionsModal').classList.add('show');
}

function closeChatOptionsModal() {
  document.getElementById('chatOptionsModal').classList.remove('show');
}

async function startNewChat(userEmail) {
  try {
    const initialMessage = prompt(`Enter your message to ${userEmail}:`);
    if (!initialMessage || initialMessage.trim() === '') {
      return;
    }

    const response = await fetch('/api/conversations', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        seller_email: userEmail,
        initial_message: initialMessage.trim()
      })
    });

    const data = await response.json();

    if (response.ok) {
      window.location.reload();
    } else {
      showNotification('Failed to start conversation: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('Error starting conversation:', error);
    showNotification('Network error while starting conversation', 'error');
  }
  
  closeNewChatModal();
}

function executeOption(action) {
  closeChatOptionsModal();
  
  const activeConversation = document.querySelector('.conversation-item.active');
  
  if (!activeConversation) {
    showNotification('Please select a conversation first', 'error');
    return;
  }
  
  switch(action) {
    case 'archive':
      activeConversation.dataset.status = 'archived';
      activeConversation.style.display = 'none';
      if (!activeConversation.querySelector('.archived-indicator')) {
        activeConversation.innerHTML += '<span class="archived-indicator" style="font-size: 0.7rem; color: #666; margin-top: 0.3rem; display: block;">📁 Archived</span>';
      }
      showNotification('Conversation archived successfully!', 'success');
      updateConversationCounts();
      loadEmptyChat();
      break;
      
    case 'unarchive':
      activeConversation.dataset.status = 'active';
      activeConversation.style.display = 'block';
      const archivedIndicator = activeConversation.querySelector('.archived-indicator');
      if (archivedIndicator) {
        archivedIndicator.remove();
      }
      showNotification('Conversation unarchived successfully!', 'success');
      updateConversationCounts();
      break;
      
    case 'mute':
      activeConversation.dataset.status = 'muted';
      const nameSpan = activeConversation.querySelector('.conversation-name');
      if (!nameSpan.querySelector('.muted-indicator')) {
        nameSpan.innerHTML += ' <i class="fas fa-bell-slash muted-indicator" style="color: #666; font-size: 0.7rem; margin-left: 0.3rem;"></i>';
      }
      showNotification('Notifications muted for this chat.', 'info');
      updateConversationCounts();
      break;
      
    case 'unmute':
      activeConversation.dataset.status = 'active';
      const mutedIndicator = activeConversation.querySelector('.muted-indicator');
      if (mutedIndicator) {
        mutedIndicator.remove();
      }
      showNotification('Notifications unmuted for this chat.', 'success');
      updateConversationCounts();
      break;
      
    case 'clear':
      const messagesArea = document.getElementById('messagesArea');
      messagesArea.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">💨 Chat history cleared</div>';
      showNotification('Chat history cleared.', 'success');
      break;
      
    case 'block':
      activeConversation.dataset.status = 'blocked';
      activeConversation.classList.add('blocked-conversation');
      activeConversation.style.display = 'none';
      if (!activeConversation.querySelector('.blocked-indicator')) {
        activeConversation.innerHTML += '<span class="blocked-indicator" style="font-size: 0.7rem; color: #dc3545; margin-top: 0.3rem; display: block;">🚫 Blocked</span>';
      }
      showNotification('User has been blocked.', 'error');
      updateConversationCounts();
      loadEmptyChat();
      break;
      
    case 'unblock':
      activeConversation.dataset.status = 'active';
      activeConversation.classList.remove('blocked-conversation');
      activeConversation.style.display = 'block';
      const blockedIndicator = activeConversation.querySelector('.blocked-indicator');
      if (blockedIndicator) {
        blockedIndicator.remove();
      }
      showNotification('User has been unblocked.', 'success');
      updateConversationCounts();
      break;
      
    case 'report':
      showNotification('User reported. Our team will review this.', 'error');
      break;
  }
}

function loadEmptyChat() {
  document.getElementById('chatTitle').textContent = 'Select a conversation';
  document.getElementById('chatSubtitle').textContent = 'Choose a conversation to start messaging';
  document.getElementById('messageInputArea').style.display = 'none';
  document.getElementById('chatOptionsBtn').style.display = 'none';
  document.getElementById('viewProductBtn').style.display = 'none';
  
  const messagesArea = document.getElementById('messagesArea');
  messagesArea.innerHTML = `
    <div class="empty-chat">
      <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
      <h5>No conversation selected</h5>
      <p>Choose a conversation from the sidebar to start messaging</p>
    </div>
  `;
}

// Global function for starting conversations from product listings
window.startConversationFromListing = async function(listingId, sellerEmail, productTitle) {
  try {
    if (!currentUser) {
      alert('Please log in to contact sellers');
      window.location.href = '/login';
      return;
    }

    const message = prompt(`Send a message about "${productTitle}":`);
    if (!message || message.trim() === '') {
      return;
    }

    const response = await fetch('/start-conversation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        listing_id: listingId,
        message: message.trim()
      })
    });

    const data = await response.json();

    if (response.ok) {
      window.location.href = `/messages?conversation=${data.conversation_id}`;
    } else {
      alert('Error: ' + data.error);
    }
  } catch (error) {
    console.error('Error starting conversation:', error);
    alert('Network error while contacting seller');
  }
};

function viewProductDetails(listingId = null) {
  if (listingId) {
    // Redirect to listing details page with the specific listing ID
    window.location.href = `/listing/${listingId}`;
    return;
  }
  
  const currentProduct = document.getElementById('chatSubtitle').textContent.replace('About: ', '');
  
  if (currentProduct === 'General conversation' || currentProduct === 'New Conversation') {
    showNotification('No product associated with this conversation', 'info');
    return;
  }
  
  showNotification(`Opening ${currentProduct} details...`, 'success');
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showError(message) {
  showNotification(message, 'error');
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 8px;
    font-weight: 500;
    padding: 12px 16px;
    border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb'};
    background-color: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1'};
    color: ${type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460'};
  `;
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" style="background: none; border: none; font-size: 1.2rem; font-weight: bold; color: inherit; opacity: 0.5; float: right; margin-left: 10px; cursor: pointer;" onclick="this.parentElement.remove()">&times;</button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}

// ========== MESSAGE DELETION FUNCTIONS ==========

function showMessageOptions(event, messageId) {
  event.preventDefault();
  
  // Remove any existing context menu
  const existingMenu = document.getElementById('message-context-menu');
  if (existingMenu) {
    existingMenu.remove();
  }
  
  // Create context menu
  const contextMenu = document.createElement('div');
  contextMenu.id = 'message-context-menu';
  contextMenu.className = 'message-context-menu';
  contextMenu.innerHTML = `
    <button onclick="deleteMessage(${messageId}, 'for_me')" class="delete-option">
      <i class="fas fa-user-minus"></i> Delete for me
    </button>
    <button onclick="deleteMessage(${messageId}, 'for_everyone')" class="delete-option delete-everyone">
      <i class="fas fa-trash"></i> Delete for everyone
    </button>
  `;
  
  // Position the menu at cursor
  contextMenu.style.left = event.pageX + 'px';
  contextMenu.style.top = event.pageY + 'px';
  
  // Add to page
  document.body.appendChild(contextMenu);
  
  // Hide menu when clicking elsewhere
  setTimeout(() => {
    document.addEventListener('click', function hideMenu(e) {
      if (!contextMenu.contains(e.target)) {
        contextMenu.remove();
        document.removeEventListener('click', hideMenu);
      }
    });
  }, 100);
  
  // Hide menu on scroll
  document.addEventListener('scroll', function hideMenuOnScroll() {
    contextMenu.remove();
    document.removeEventListener('scroll', hideMenuOnScroll);
  });
}

async function deleteMessage(messageId, deleteType) {
  if (!currentConversationId) {
    showNotification('No conversation selected', 'error');
    return;
  }
  
  const confirmMessage = deleteType === 'for_everyone' 
    ? 'Are you sure you want to delete this message for everyone? This cannot be undone.'
    : 'Are you sure you want to delete this message for yourself?';
    
  if (!confirm(confirmMessage)) {
    return;
  }
  
  try {
    const response = await fetch(`/api/conversations/${currentConversationId}/messages/${messageId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        delete_type: deleteType
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      showNotification(
        deleteType === 'for_everyone' ? 'Message deleted for everyone' : 'Message deleted for you', 
        'success'
      );
      
      // Remove the context menu
      const contextMenu = document.getElementById('message-context-menu');
      if (contextMenu) {
        contextMenu.remove();
      }
      
      // Reload messages to reflect the change
      await loadMessages(currentConversationId);
    } else {
      showNotification('Failed to delete message: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('Error deleting message:', error);
    showNotification('Network error while deleting message', 'error');
  }
}

// ========== IMAGE HANDLING FUNCTIONS ==========

function handleImageSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Check file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    showError('Image size must be less than 5MB');
    return;
  }
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    showError('Please select a valid image file');
    return;
  }
  
  selectedImage = file;
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    const previewImage = document.getElementById('previewImage');
    const imagePreview = document.getElementById('imagePreview');
    
    previewImage.src = e.target.result;
    imagePreview.style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function removeImagePreview() {
  selectedImage = null;
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('imageInput').value = '';
}

function openImageModal(imageUrl) {
  // Create image modal
  const modal = document.createElement('div');
  modal.className = 'image-modal';
  modal.innerHTML = `
    <div class="image-modal-content">
      <span class="image-modal-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
      <img src="${imageUrl}" alt="Full size image">
    </div>
  `;
  
  // Add styles
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;
  
  const content = modal.querySelector('.image-modal-content');
  content.style.cssText = `
    position: relative;
    max-width: 90%;
    max-height: 90%;
  `;
  
  const img = modal.querySelector('img');
  img.style.cssText = `
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  `;
  
  const closeBtn = modal.querySelector('.image-modal-close');
  closeBtn.style.cssText = `
    position: absolute;
    top: -30px;
    right: 0;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    background: rgba(0, 0, 0, 0.7);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  document.body.appendChild(modal);
  
  // Close on background click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      modal.remove();
    }
  }, { once: true });
}

console.log('Messages page fully loaded!');
</script>