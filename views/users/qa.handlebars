<!-- Complete User Q&A Template -->
<link rel="stylesheet" href="/assets/css/users/faq.css">

<!-- Hero Section - Full Width -->
<section class="hero-section">
  <div class="hero-content">
    <h1 class="hero-title">Community Q&A</h1>
    <p class="hero-subtitle">Get answers from the Vintique community about sustainable fashion, care tips, and more</p>
    
    <div class="search-container">
      <div class="d-flex align-items-center">
        <input type="text" class="search-input" placeholder="Search questions and answers..." id="searchInput">
        <button class="search-btn" onclick="searchQA()">
          <i class="fas fa-search me-2"></i>Search
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Main Content -->
<div class="container">
  <!-- Stats Section -->
  <div class="stats-section">
    <div class="stat-item">
      <div class="stat-number" id="qaCount">{{#if questions}}{{questions.length}}{{else}}0{{/if}}</div>
      <div class="stat-label">Total Questions</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="answeredCount">
        {{#if questions}}
          {{#each questions}}
            {{#if this.answers}}{{#if (gt this.answers.length 0)}}1{{else}}0{{/if}}{{else}}0{{/if}}
          {{/each}}
        {{else}}0{{/if}}
      </div>
      <div class="stat-label">Questions Answered</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">95%</div>
      <div class="stat-label">Answer Rate</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">24h</div>
      <div class="stat-label">Avg Response Time</div>
    </div>
  </div>

  <!-- Ask Question Section -->
  <div class="ask-question-section">
    {{#if user}}
      <button class="ask-btn" data-bs-toggle="modal" data-bs-target="#askQuestionModal">
        <i class="fas fa-plus me-2"></i>Ask a Question
      </button>
      <p class="text-muted mb-0">Have a question about sustainable fashion, product care, or anything Vintique-related? Ask our community!</p>
      <small class="text-info">
        <i class="fas fa-info-circle me-1"></i>
        Questions are reviewed by our moderators before being published to ensure quality and relevance.
      </small>
    {{else}}
      <a href="/login" class="ask-btn">
        <i class="fas fa-sign-in-alt me-2"></i>Login to Ask Questions
      </a>
      <p class="text-muted mb-0">Have a question about sustainable fashion, product care, or anything Vintique-related? Ask our community!</p>
    {{/if}}
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filter-tabs">
      <button class="filter-tab active" onclick="filterCategory('all')">All Questions</button>
      <button class="filter-tab" onclick="filterCategory('general')">General</button>
      <button class="filter-tab" onclick="filterCategory('care')">Care & Maintenance</button>
      <button class="filter-tab" onclick="filterCategory('sustainability')">Sustainability</button>
      <button class="filter-tab" onclick="filterCategory('sizing')">Sizing & Fit</button>
      <button class="filter-tab" onclick="filterCategory('selling')">Selling Tips</button>
      <button class="filter-tab" onclick="filterCategory('answered')">Answered</button>
      <button class="filter-tab" onclick="filterCategory('unanswered')">Unanswered</button>
    </div>

    <div class="modern-filters">
      <div class="filter-group">
        <label class="filter-label">Sort By</label>
        <select class="form-select" id="sortBy" onchange="sortQuestions()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="most-helpful">Most Helpful</option>
          <option value="unanswered">Unanswered First</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Status Filter</label>
        <select class="form-select" id="statusFilter" onchange="applyFilters()">
          <option value="">All Status</option>
          <option value="answered">Answered</option>
          <option value="pending">Pending Answer</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Q&A Grid -->
  <div class="qa-grid" id="qaGrid">
    {{#if questions}}
      {{#each questions}}
        <div class="qa-card" data-category="{{this.category}}" data-status="{{#if this.answers}}{{#if (gt this.answers.length 0)}}answered{{else}}pending{{/if}}{{else}}pending{{/if}}" data-helpful="{{#if this.helpful_count}}{{this.helpful_count}}{{else}}0{{/if}}" data-question-id="{{this.qa_id}}">
          <div class="qa-header">
            <div>
              <span class="qa-category">{{this.category}}</span>
              <span class="qa-status {{#if this.answers}}{{#if (gt this.answers.length 0)}}status-answered{{else}}status-pending{{/if}}{{else}}status-pending{{/if}}">
                {{#if this.answers}}{{#if (gt this.answers.length 0)}}Answered ({{this.answers.length}} {{#if (eq this.answers.length 1)}}reply{{else}}replies{{/if}}){{else}}Pending Answer{{/if}}{{else}}Pending Answer{{/if}}
              </span>
            </div>
            <div class="qa-date">{{timeAgo this.asked_at}}</div>
          </div>
          
          <div class="question">{{this.question_text}}</div>
          {{#if this.details}}
            <div class="question-details">{{this.details}}</div>
          {{/if}}
          <div class="questioner">Asked by {{#if this.asker_username}}<a href="/user/{{this.asker_username}}" class="user-link">@{{this.asker_username}}</a>{{else}}{{this.asker_email}}{{/if}}</div>
          
          {{#if this.answers}}
            {{#if (gt this.answers.length 0)}}
              <div class="answers-section">
                <div class="answers-header">
                  <h6><i class="fas fa-comments me-2"></i>{{this.answers.length}} {{#if (eq this.answers.length 1)}}Answer{{else}}Answers{{/if}}</h6>
                  {{#if (gt this.answers.length 1)}}
                    <div class="answers-toggle">
                      <button class="toggle-answers-btn" onclick="toggleAllAnswers(this)" data-show-all="false">
                        <span class="show-text">Show All Answers</span>
                        <span class="hide-text" style="display: none;">Show Latest Only</span>
                        <i class="fas fa-chevron-down ms-1"></i>
                      </button>
                    </div>
                  {{/if}}
                </div>
                
                <div class="answers-container">
                  {{#each this.answers}}
                    <div class="answer {{#if @first}}latest-answer{{else}}older-answer{{/if}}" {{#unless @first}}style="display: none;"{{/unless}}>
                      <div class="answerer">
                        <i class="fas fa-check-circle me-1"></i>
                        Answered by {{#if this.answerer_username}}<a href="/user/{{this.answerer_username}}" class="user-link">@{{this.answerer_username}}</a>{{else}}{{this.answerer_email}}{{/if}}
                        <span class="answer-date">{{timeAgo this.answered_at}}</span>
                      </div>
                      <div class="answer-text">{{this.answer_content}}</div>
                    </div>
                  {{/each}}
                </div>
              </div>
            {{/if}}
          {{/if}}
          
          <div class="qa-actions">
            <div class="vote-section">
              <button class="vote-btn" onclick="voteHelpful(this, {{this.qa_id}})" data-voted="false">
                <i class="fas fa-thumbs-up me-1"></i>Helpful
              </button>
              <span class="helpful-count">{{#if this.helpful_count}}{{this.helpful_count}}{{else}}0{{/if}} found this helpful</span>
            </div>
            {{#if ../user}}
              <button class="reply-btn" onclick="showReplyForm(this, {{this.qa_id}})">
                <i class="fas fa-reply me-1"></i>Add Answer
              </button>
            {{/if}}
          </div>
        </div>
      {{/each}}
    {{else}}
      <div class="empty-state">
        <i class="fas fa-question-circle"></i>
        <h3>No questions yet</h3>
        <p>Be the first to ask a question about sustainable fashion!</p>
        {{#if user}}
          <button class="ask-btn" data-bs-toggle="modal" data-bs-target="#askQuestionModal">
            <i class="fas fa-plus me-2"></i>Ask First Question
          </button>
        {{/if}}
      </div>
    {{/if}}
  </div>
</div>

<!-- Ask Question Modal -->
{{#if user}}
<div class="modal fade" id="askQuestionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ask a Question</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Before submitting:</strong> Your question will be reviewed by our moderators before being published. This helps maintain quality and ensures relevant content for our community.
        </div>
        <form id="askQuestionForm">
          <div class="mb-3">
            <label for="questionCategory" class="form-label">Category</label>
            <select class="form-select" id="questionCategory" required>
              <option value="">Select a category</option>
              <option value="general">General</option>
              <option value="care">Care & Maintenance</option>
              <option value="sustainability">Sustainability</option>
              <option value="sizing">Sizing & Fit</option>
              <option value="selling">Selling Tips</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="questionTitle" class="form-label">Question</label>
            <textarea class="form-control" id="questionTitle" rows="3" placeholder="What would you like to know?" required></textarea>
          </div>
          <div class="mb-3">
            <label for="questionDetails" class="form-label">Additional Details (Optional)</label>
            <textarea class="form-control" id="questionDetails" rows="4" placeholder="Provide more context or details about your question..."></textarea>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit for Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{{/if}}

<style>
.answers-section {
  margin-top: 1rem;
  border-top: 1px solid #e9ecef;
  padding-top: 1rem;
}

.answers-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.answers-header h6 {
  margin: 0;
  color: #495057;
  font-weight: 600;
}

.toggle-answers-btn {
  background: none;
  border: none;
  color: #007bff;
  font-size: 0.875rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.toggle-answers-btn:hover {
  background-color: #f8f9fa;
}

.answers-container {
  space-y: 1rem;
}

.answer {
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.latest-answer {
  border-left: 4px solid #28a745;
}

.older-answer {
  border-left: 4px solid #6c757d;
}

.answerer {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  font-size: 0.875rem;
  color: #495057;
  font-weight: 500;
}

.answer-date {
  color: #6c757d;
  font-weight: 400;
  margin-left: auto;
}

.answer-text {
  color: #212529;
  line-height: 1.5;
  white-space: pre-line;
}

.question-details {
  color: #6c757d;
  font-size: 0.9rem;
  margin-top: 0.5rem;
  padding: 0.75rem;
  background-color: #f8f9fa;
  border-radius: 6px;
  border-left: 3px solid #dee2e6;
}

/* Reply form styles */
.reply-form {
  margin-top: 1rem;
  padding: 1rem;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease;
}

.reply-form.show {
  opacity: 1;
  max-height: 300px;
  margin-bottom: 1rem;
}

.reply-textarea {
  width: 100%;
  min-height: 80px;
  padding: 0.75rem;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: 0.9rem;
  resize: vertical;
  margin-bottom: 1rem;
}

.reply-form-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-submit-reply {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.btn-submit-reply:hover {
  background-color: #0056b3;
}

.btn-cancel-reply {
  background-color: #6c757d;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.btn-cancel-reply:hover {
  background-color: #545b62;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('FAQ page loaded');
  updateCounts();
  
  // Handle ask question form
  {{#if user}}
  const askForm = document.getElementById('askQuestionForm');
  if (askForm) {
    askForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      await submitQuestion();
    });
  }
  {{/if}}
  
  // Search functionality
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchQA();
      }
    });
    
    searchInput.addEventListener('input', function(e) {
      if (e.target.value.trim() === '') {
        searchQA();
      }
    });
  }

  // Load user's vote status
  {{#if user}}
  loadUserVoteStatus();
  {{/if}}
});

{{#if user}}
async function loadUserVoteStatus() {
  try {
    const response = await fetch('/api/qa/votes/status');
    if (response.ok) {
      const votedQuestions = await response.json();
      votedQuestions.forEach(qaId => {
        const voteBtn = document.querySelector(`[onclick*="voteHelpful"][onclick*="${qaId}"]`);
        if (voteBtn) {
          voteBtn.classList.add('active');
          voteBtn.dataset.voted = 'true';
        }
      });
    }
  } catch (error) {
    console.error('Error loading vote status:', error);
  }
}
{{/if}}

function toggleAllAnswers(button) {
  const answersContainer = button.closest('.answers-section').querySelector('.answers-container');
  const olderAnswers = answersContainer.querySelectorAll('.older-answer');
  const showText = button.querySelector('.show-text');
  const hideText = button.querySelector('.hide-text');
  const icon = button.querySelector('i');
  const isShowingAll = button.dataset.showAll === 'true';
  
  if (isShowingAll) {
    // Hide older answers
    olderAnswers.forEach(answer => {
      answer.style.display = 'none';
    });
    showText.style.display = 'inline';
    hideText.style.display = 'none';
    icon.className = 'fas fa-chevron-down ms-1';
    button.dataset.showAll = 'false';
  } else {
    // Show all answers
    olderAnswers.forEach(answer => {
      answer.style.display = 'block';
    });
    showText.style.display = 'none';
    hideText.style.display = 'inline';
    icon.className = 'fas fa-chevron-up ms-1';
    button.dataset.showAll = 'true';
  }
}

function searchQA() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const qaCards = document.querySelectorAll('.qa-card');
  let visibleCount = 0;
  
  qaCards.forEach(card => {
    const question = card.querySelector('.question').textContent.toLowerCase();
    const answers = card.querySelectorAll('.answer-text');
    let answerText = '';
    answers.forEach(answer => {
      answerText += answer.textContent.toLowerCase() + ' ';
    });
    const category = card.querySelector('.qa-category').textContent.toLowerCase();
    
    if (question.includes(searchTerm) || answerText.includes(searchTerm) || category.includes(searchTerm)) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  document.getElementById('qaCount').textContent = visibleCount;
}

function filterCategory(category) {
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  const qaCards = document.querySelectorAll('.qa-card');
  let visibleCount = 0;
  
  qaCards.forEach(card => {
    let showCard = true;
    
    if (category === 'answered') {
      showCard = card.dataset.status === 'answered';
    } else if (category === 'unanswered') {
      showCard = card.dataset.status === 'pending';
    } else if (category !== 'all') {
      showCard = card.dataset.category === category;
    }
    
    if (showCard) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  document.getElementById('qaCount').textContent = visibleCount;
}

function applyFilters() {
  const status = document.getElementById('statusFilter').value;
  const qaCards = document.querySelectorAll('.qa-card');
  let visibleCount = 0;
  
  qaCards.forEach(card => {
    let showCard = true;
    
    if (status && card.dataset.status !== status) {
      showCard = false;
    }
    
    if (showCard) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  document.getElementById('qaCount').textContent = visibleCount;
}

function sortQuestions() {
  const sortBy = document.getElementById('sortBy').value;
  const qaGrid = document.getElementById('qaGrid');
  const questions = Array.from(qaGrid.children);
  
  questions.sort((a, b) => {
    switch (sortBy) {
      case 'most-helpful':
        return parseInt(b.dataset.helpful) - parseInt(a.dataset.helpful);
      case 'oldest':
        return 1; // Simple implementation - in real app would use actual dates
      case 'unanswered':
        if (a.dataset.status === 'pending' && b.dataset.status === 'answered') return -1;
        if (a.dataset.status === 'answered' && b.dataset.status === 'pending') return 1;
        return 0;
      case 'newest':
      default:
        return 0; // Keep original order for newest
    }
  });
  
  qaGrid.innerHTML = '';
  questions.forEach(question => qaGrid.appendChild(question));
}

async function voteHelpful(button, questionId) {
  {{#unless user}}
    alert('Please log in to vote');
    return;
  {{/unless}}
  
  try {
    const response = await fetch(`/api/qa/${questionId}/vote`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (response.ok) {
      button.classList.toggle('active');
      const helpfulSpan = button.parentElement.querySelector('.helpful-count');
      
      if (data.voted) {
        helpfulSpan.textContent = `${data.vote_count} found this helpful`;
        button.parentElement.parentElement.parentElement.dataset.helpful = data.vote_count;
      } else {
        helpfulSpan.textContent = `${data.vote_count} found this helpful`;
        button.parentElement.parentElement.parentElement.dataset.helpful = data.vote_count;
      }
      button.dataset.voted = data.voted;
    } else {
      showError(data.error || 'Failed to vote');
    }
  } catch (error) {
    console.error('Error voting:', error);
    showError('Network error while voting');
  }
}

function showReplyForm(button, questionId) {
  {{#unless user}}
    alert('Please log in to answer questions');
    return;
  {{/unless}}
  
  // Hide any existing reply forms
  document.querySelectorAll('.reply-form').forEach(form => {
    form.classList.remove('show');
  });

  // Get the parent qa-card
  const qaCard = button.closest('.qa-card');
  
  // Check if reply form already exists
  let replyForm = qaCard.querySelector('.reply-form');
  
  if (!replyForm) {
    // Create reply form
    replyForm = document.createElement('div');
    replyForm.className = 'reply-form';
    replyForm.innerHTML = `
      <h6 style="color: #333; margin-bottom: 1rem;">Add your answer:</h6>
      <textarea placeholder="Write your answer here..." class="reply-textarea" required></textarea>
      <div class="reply-form-actions">
        <button class="btn-submit-reply" onclick="submitReply(this, ${questionId})">Submit Answer</button>
        <button class="btn-cancel-reply" onclick="cancelReply(this)">Cancel</button>
      </div>
    `;
    
    // Insert before qa-actions
    const qaActions = qaCard.querySelector('.qa-actions');
    qaActions.parentNode.insertBefore(replyForm, qaActions);
  }
  
  // Show the form
  replyForm.classList.add('show');
  
  // Focus on textarea
  const textarea = replyForm.querySelector('textarea');
  textarea.focus();
}

function cancelReply(button) {
  const replyForm = button.closest('.reply-form');
  replyForm.classList.remove('show');
  
  // Clear textarea
  const textarea = replyForm.querySelector('textarea');
  textarea.value = '';
}

async function submitReply(button, questionId) {
  const replyForm = button.closest('.reply-form');
  const textarea = replyForm.querySelector('textarea');
  const replyText = textarea.value.trim();
  
  if (!replyText) {
    alert('Please write an answer before submitting.');
    return;
  }
  
  // Disable button during submission
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'Submitting...';
  
  try {
    const response = await fetch(`/api/qa/${questionId}/answer`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        answer_content: replyText
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Reload the page to show the new answer
      showSuccess('Answer submitted successfully!');
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      showError(data.error || 'Failed to submit answer');
    }
  } catch (error) {
    console.error('Error submitting answer:', error);
    showError('Network error while submitting answer');
  } finally {
    // Re-enable button
    button.disabled = false;
    button.textContent = originalText;
  }
}

async function submitQuestion() {
  const category = document.getElementById('questionCategory').value;
  const questionText = document.getElementById('questionTitle').value.trim();
  const details = document.getElementById('questionDetails').value.trim();
  
  if (!category || !questionText) {
    alert('Please fill in the required fields.');
    return;
  }
  
  // Disable submit button to prevent double submission
  const submitBtn = document.querySelector('#askQuestionModal .btn-primary');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  
  try {
    const response = await fetch('/api/qa', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        category: category,
        question_text: questionText,
        details: details
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('askQuestionModal'));
      modal.hide();
      
      // Reset form
      document.getElementById('askQuestionForm').reset();
      
      // Show success message with moderation notice
      showSuccess('Question submitted successfully! Your question will be reviewed by our moderators and published once approved. You will be able to see it in the Q&A section after verification.');
      
    } else {
      showError(data.error || 'Failed to submit question');
    }
  } catch (error) {
    console.error('Error submitting question:', error);
    showError('Network error while submitting question');
  } finally {
    // Re-enable submit button
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

function updateCounts() {
  const qaCards = document.querySelectorAll('.qa-card');
  const answeredCards = document.querySelectorAll('.qa-card[data-status="answered"]');
  
  document.getElementById('qaCount').textContent = qaCards.length;
  document.getElementById('answeredCount').textContent = answeredCards.length;
}

function showError(message) {
  showNotification(message, 'error');
}

function showSuccess(message) {
  showNotification(message, 'success');
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 8px;
    font-weight: 500;
  `;
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.classList.add('fade');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 150);
    }
  }, 5000);
  
  const closeBtn = notification.querySelector('.btn-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      notification.remove();
    });
  }
}

console.log('FAQ page fully loaded!');
</script>